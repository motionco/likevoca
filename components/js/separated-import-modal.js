import {
  auth,
  db,
  conceptUtils,
  supportedLanguages,
  serverTimestamp,
} from "../../js/firebase/firebase-init.js";
import { collectionManager } from "../../js/firebase/firebase-collection-manager.js";
import { readFile } from "./csv-parser-utils.js";

// Ï†ÑÏó≠ Î≥ÄÏàò
let currentTab = "concepts";
let selectedFiles = {
  concepts: null,
  examples: null,
  grammar: null,
};

export function initialize() {
  console.log("Î∂ÑÎ¶¨Îêú ÎåÄÎüâ Í∞ÄÏ†∏Ïò§Í∏∞ Î™®Îã¨ Ï¥àÍ∏∞Ìôî");

  setupTabNavigation();
  setupEventListeners();
}

function setupTabNavigation() {
  const tabs = ["concepts", "examples", "grammar"];

  tabs.forEach((tabName) => {
    const tabButton = document.getElementById(`${tabName}-tab`);
    const tabContent = document.getElementById(`${tabName}-content`);

    if (tabButton) {
      tabButton.addEventListener("click", () => {
        // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
        tabs.forEach((t) => {
          document
            .getElementById(`${t}-tab`)
            ?.classList.remove("active", "text-blue-600", "border-blue-600");
          document.getElementById(`${t}-tab`)?.classList.add("text-gray-600");
          document.getElementById(`${t}-content`)?.classList.add("hidden");
        });

        // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
        tabButton.classList.remove("text-gray-600");
        tabButton.classList.add("active", "text-blue-600", "border-blue-600");
        tabContent?.classList.remove("hidden");

        currentTab = tabName;
      });
    }
  });
}

function setupEventListeners() {
  // Î™®Îã¨ Îã´Í∏∞
  const closeBtn = document.getElementById("close-separated-modal");
  const cancelBtn = document.getElementById("cancel-separated-import");

  if (closeBtn) closeBtn.addEventListener("click", closeModal);
  if (cancelBtn) cancelBtn.addEventListener("click", closeModal);

  // Í∞Å ÌÉ≠Î≥Ñ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
  setupTabEventListeners("concepts");
  setupTabEventListeners("examples");
  setupTabEventListeners("grammar");
}

function setupTabEventListeners(tabName) {
  // ÌååÏùº ÏÑ†ÌÉù Î≤ÑÌäº
  const browseBtn = document.getElementById(`browse-${tabName}-file`);
  const fileInput = document.getElementById(`${tabName}-file-input`);
  const fileName = document.getElementById(`${tabName}-file-name`);
  const uploadBtn = document.getElementById(`upload-${tabName}`);
  const downloadBtn = document.getElementById(`download-${tabName}-template`);

  if (browseBtn && fileInput) {
    browseBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFiles[tabName] = file;
        fileName.textContent = `ÏÑ†ÌÉùÎêú ÌååÏùº: ${file.name}`;
        uploadBtn.disabled = false;
      }
    });
  }

  if (uploadBtn) {
    uploadBtn.addEventListener("click", () => uploadFile(tabName));
  }

  if (downloadBtn) {
    downloadBtn.addEventListener("click", () => downloadTemplate(tabName));
  }
}

function closeModal() {
  const modal = document.getElementById("separated-import-modal");
  if (modal) {
    modal.classList.add("hidden");

    // Ï¥àÍ∏∞Ìôî
    selectedFiles = { concepts: null, examples: null, grammar: null };
    ["concepts", "examples", "grammar"].forEach((tab) => {
      const fileName = document.getElementById(`${tab}-file-name`);
      const uploadBtn = document.getElementById(`upload-${tab}`);
      const progressDiv = document.getElementById(`${tab}-progress`);

      if (fileName) fileName.textContent = "";
      if (uploadBtn) uploadBtn.disabled = true;
      if (progressDiv) progressDiv.classList.add("hidden");
    });
  }
}

async function uploadFile(tabName) {
  const file = selectedFiles[tabName];
  if (!file) return;

  const formatSelect = document.getElementById(`${tabName}-format`);
  const format = formatSelect.value;
  const progressDiv = document.getElementById(`${tabName}-progress`);
  const progressBar = document.getElementById(`${tabName}-progress-bar`);
  const statusDiv = document.getElementById(`${tabName}-status`);

  try {
    progressDiv.classList.remove("hidden");
    statusDiv.textContent = "ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë...";
    progressBar.style.width = "20%";

    const fileContent = await readFile(file);
    let data;

    if (format === "json") {
      data = JSON.parse(fileContent);
    } else {
      data = parseCSV(fileContent, tabName);
    }

    statusDiv.textContent = "Îç∞Ïù¥ÌÑ∞Î•º Ï≤òÎ¶¨ÌïòÎäî Ï§ë...";
    progressBar.style.width = "50%";

    // Ïª¨Î†âÏÖòÎ≥Ñ ÏóÖÎ°úÎìú Ï≤òÎ¶¨
    let result;
    switch (tabName) {
      case "concepts":
        result = await uploadConcepts(data);
        break;
      case "examples":
        result = await uploadExamples(data);
        break;
      case "grammar":
        result = await uploadGrammarPatterns(data);
        break;
    }

    progressBar.style.width = "100%";
    statusDiv.textContent = `ÏóÖÎ°úÎìú ÏôÑÎ£å: ${result.success}Í∞ú ÏÑ±Í≥µ, ${result.errors}Í∞ú Ïã§Ìå®`;

    setTimeout(() => {
      progressDiv.classList.add("hidden");
    }, 3000);
  } catch (error) {
    console.error(`${tabName} ÏóÖÎ°úÎìú Ïò§Î•ò:`, error);
    statusDiv.textContent = `Ïò§Î•ò Î∞úÏÉù: ${error.message}`;
    progressBar.style.width = "0%";
  }
}

async function uploadConcepts(data) {
  const concepts = Array.isArray(data) ? data : [data];
  let success = 0;
  let errors = 0;

  for (const conceptData of concepts) {
    try {
      const conceptDoc = {
        concept_info: conceptData.concept_info || {
          domain: conceptData.domain || "general",
          category: conceptData.category || "uncategorized",
          difficulty: conceptData.difficulty || "beginner",
          unicode_emoji: conceptData.emoji || "üìù",
          color_theme: conceptData.color_theme || "#9C27B0",
          tags: conceptData.tags || [],
          updated_at: new Date(),
        },
        expressions: conceptData.expressions || {},
        representative_example: conceptData.representative_example || null,
        learning_metadata: {
          pattern_name: null,
          structural_pattern: null,
          learning_weight: 5,
          quiz_eligible: true,
          game_eligible: true,
        },
        created_at: serverTimestamp(),
      };

      await collectionManager.createConcept(conceptDoc);
      success++;
    } catch (error) {
      console.error("Í∞úÎÖê ÏóÖÎ°úÎìú Ïò§Î•ò:", error);
      errors++;
    }
  }

  return { success, errors };
}

async function uploadExamples(data) {
  const examples = Array.isArray(data) ? data : [data];
  let success = 0;
  let errors = 0;

  for (const exampleData of examples) {
    try {
      const exampleDoc = {
        example_id:
          exampleData.example_id ||
          `example_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        domain: exampleData.domain || "general",
        category: exampleData.category || "common",
        context: exampleData.context || "general",
        difficulty: exampleData.difficulty || "beginner",
        tags: exampleData.tags || [],
        translations: exampleData.translations || {},
        learning_metadata: {
          pattern_name: exampleData.learning_metadata?.pattern_name || null,
          structural_pattern:
            exampleData.learning_metadata?.structural_pattern || null,
          learning_weight: exampleData.learning_metadata?.learning_weight || 5,
          quiz_eligible: exampleData.learning_metadata?.quiz_eligible !== false,
          game_eligible: exampleData.learning_metadata?.game_eligible !== false,
        },
      };

      await collectionManager.createExample(exampleDoc);
      success++;
    } catch (error) {
      console.error("ÏòàÎ¨∏ ÏóÖÎ°úÎìú Ïò§Î•ò:", error);
      errors++;
    }
  }

  return { success, errors };
}

async function uploadGrammarPatterns(data) {
  const patterns = Array.isArray(data) ? data : [data];
  let success = 0;
  let errors = 0;

  for (const patternData of patterns) {
    try {
      const patternDoc = {
        pattern_id:
          patternData.pattern_id ||
          `pattern_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        pattern_name: patternData.pattern_name || "Í∏∞Î≥∏ Ìå®ÌÑ¥",
        pattern_type: patternData.pattern_type || "basic",
        domain: patternData.domain || "general",
        category: patternData.category || "common",
        difficulty: patternData.difficulty || "beginner",
        tags: patternData.tags || [],
        learning_focus: patternData.learning_focus || [],
        structural_pattern: patternData.structural_pattern || "",
        explanations: patternData.explanations || {},
        usage_examples: patternData.usage_examples || [],
      };

      await collectionManager.createGrammarPattern(patternDoc);
      success++;
    } catch (error) {
      console.error("Î¨∏Î≤ï Ìå®ÌÑ¥ ÏóÖÎ°úÎìú Ïò§Î•ò:", error);
      errors++;
    }
  }

  return { success, errors };
}

function downloadTemplate(tabName) {
  switch (tabName) {
    case "concepts":
      downloadConceptsTemplate();
      break;
    case "examples":
      downloadExamplesTemplate();
      break;
    case "grammar":
      downloadGrammarTemplate();
      break;
  }
}

function downloadConceptsTemplate() {
  const formatSelect = document.getElementById("concepts-format");
  const format = formatSelect.value;

  if (format === "json") {
    downloadConceptsJSONTemplate();
  } else {
    downloadConceptsCSVTemplate();
  }
}

function downloadConceptsJSONTemplate() {
  const template = [
    {
      concept_info: {
        domain: "daily",
        category: "fruit",
        difficulty: "beginner",
        unicode_emoji: "üçé",
        color_theme: "#FF6B6B",
        tags: ["food", "healthy", "common"],
      },
      expressions: {
        korean: {
          word: "ÏÇ¨Í≥º",
          pronunciation: "sa-gwa",
          definition: "Îë•Í∏ÄÍ≥† Îπ®Í∞Ñ Í≥ºÏùº",
          part_of_speech: "Î™ÖÏÇ¨",
          level: "beginner",
          synonyms: ["Îä•Í∏à"],
          antonyms: [],
          word_family: ["Í≥ºÏùº", "ÏùåÏãù"],
          compound_words: ["ÏÇ¨Í≥ºÎÇòÎ¨¥", "ÏÇ¨Í≥ºÏ¶ô"],
          collocations: ["Îπ®Í∞Ñ ÏÇ¨Í≥º", "ÎßõÏûàÎäî ÏÇ¨Í≥º"],
        },
        english: {
          word: "apple",
          pronunciation: "/Àà√¶p…ôl/",
          definition: "a round fruit with red or green skin",
          part_of_speech: "noun",
          level: "beginner",
          synonyms: [],
          antonyms: [],
          word_family: ["fruit", "food"],
          compound_words: ["apple tree", "apple juice"],
          collocations: ["red apple", "sweet apple"],
        },
      },
      representative_example: {
        example_id: "apple_rep_example",
        context: "daily_meal",
        difficulty: "beginner",
        translations: {
          korean: {
            text: "ÏïÑÏπ®Ïóê ÏÇ¨Í≥ºÎ•º Î®πÏñ¥Ïöî.",
            romanization: "achime sagwareul meogeoyo",
          },
          english: {
            text: "I eat an apple in the morning.",
            phonetic: "/a…™ iÀêt √¶n Àà√¶p…ôl …™n √∞…ô Ààm…îrn…™≈ã/",
          },
        },
      },
    },
  ];

  downloadJSON(template, "concepts_template.json");
}

function downloadConceptsCSVTemplate() {
  const headers = [
    "domain",
    "category",
    "emoji",
    "difficulty",
    "tags",
    "korean_word",
    "korean_pronunciation",
    "korean_definition",
    "korean_part_of_speech",
    "english_word",
    "english_pronunciation",
    "english_definition",
    "english_part_of_speech",
    "representative_example_korean",
    "representative_example_english",
  ];

  const sampleData = [
    [
      "daily",
      "fruit",
      "üçé",
      "beginner",
      "food|healthy|common",
      "ÏÇ¨Í≥º",
      "sa-gwa",
      "Îë•Í∏ÄÍ≥† Îπ®Í∞Ñ Í≥ºÏùº",
      "Î™ÖÏÇ¨",
      "apple",
      "/Àà√¶p…ôl/",
      "a round fruit with red or green skin",
      "noun",
      "ÏïÑÏπ®Ïóê ÏÇ¨Í≥ºÎ•º Î®πÏñ¥Ïöî.",
      "I eat an apple in the morning.",
    ],
  ];

  downloadCSV([headers, ...sampleData], "concepts_template.csv");
}

function downloadExamplesTemplate() {
  const formatSelect = document.getElementById("examples-format");
  const format = formatSelect.value;

  if (format === "json") {
    downloadExamplesJSONTemplate();
  } else {
    downloadExamplesCSVTemplate();
  }
}

function downloadExamplesJSONTemplate() {
  const template = [
    {
      example_id: "example_001",
      domain: "daily",
      category: "routine",
      context: "daily_conversation",
      difficulty: "beginner",
      tags: ["greeting", "polite", "formal"],
      translations: {
        korean: {
          text: "ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï≤òÏùå ÎµôÍ≤†ÏäµÎãàÎã§.",
          romanization: "annyeonghaseyo! cheoeum boepgetseumnida",
        },
        english: {
          text: "Hello! Nice to meet you for the first time.",
          phonetic: "/h…ôÀàlo ä na…™s tu mit ju f…îr √∞…ô f…úrst ta…™m/",
        },
        japanese: {
          text: "„Åì„Çì„Å´„Å°„ÅØÔºÅÂàù„ÇÅ„Å¶„Åä‰ºö„ÅÑ„Åó„Åæ„Åô„ÄÇ",
          romanization: "konnichiwa! hajimete oai shimasu",
        },
        chinese: {
          text: "‰Ω†Â•ΩÔºÅÂàùÊ¨°ËßÅÈù¢„ÄÇ",
          pinyin: "n«ê h«éo! ch≈´ c√¨ ji√†n mi√†n",
        },
      },
    },
    {
      example_id: "example_002",
      domain: "food",
      category: "fruit",
      context: "restaurant",
      difficulty: "beginner",
      tags: ["food", "ordering", "restaurant"],
      translations: {
        korean: {
          text: "ÏÇ¨Í≥º Ï£ºÏä§ ÌïòÎÇò Ï£ºÏÑ∏Ïöî.",
          romanization: "sagwa juseu hana juseyo",
        },
        english: {
          text: "Please give me one apple juice.",
          phonetic: "/pliÀêz …°…™v mi w ån Àà√¶p…ôl  §us/",
        },
        japanese: {
          text: "„Çä„Çì„Åî„Ç∏„É•„Éº„Çπ„Çí‰∏Ä„Å§„Åè„Å†„Åï„ÅÑ„ÄÇ",
          romanization: "ringo juusu wo hitotsu kudasai",
        },
        chinese: {
          text: "ËØ∑ÁªôÊàë‰∏ÄÊùØËãπÊûúÊ±Å„ÄÇ",
          pinyin: "q«êng gƒõi w«í yƒ´ bƒìi p√≠ng gu«í zhƒ´",
        },
      },
    },
  ];

  downloadJSON(template, "examples_template.json");
}

function downloadExamplesCSVTemplate() {
  const headers = [
    "example_id",
    "domain",
    "category",
    "context",
    "difficulty",
    "tags",
    "korean_text",
    "korean_romanization",
    "english_text",
    "english_phonetic",
    "japanese_text",
    "japanese_romanization",
    "chinese_text",
    "chinese_pinyin",
  ];

  const sampleData = [
    [
      "example_001",
      "daily",
      "routine",
      "daily_conversation",
      "beginner",
      "greeting|polite|formal",
      "ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï≤òÏùå ÎµôÍ≤†ÏäµÎãàÎã§.",
      "annyeonghaseyo! cheoeum boepgetseumnida",
      "Hello! Nice to meet you for the first time.",
      "/h…ôÀàlo ä na…™s tu mit ju f…îr √∞…ô f…úrst ta…™m/",
      "„Åì„Çì„Å´„Å°„ÅØÔºÅÂàù„ÇÅ„Å¶„Åä‰ºö„ÅÑ„Åó„Åæ„Åô„ÄÇ",
      "konnichiwa! hajimete oai shimasu",
      "‰Ω†Â•ΩÔºÅÂàùÊ¨°ËßÅÈù¢„ÄÇ",
      "n«ê h«éo! ch≈´ c√¨ ji√†n mi√†n",
    ],
  ];

  downloadCSV([headers, ...sampleData], "examples_template.csv");
}

function downloadGrammarTemplate() {
  const formatSelect = document.getElementById("grammar-format");
  const format = formatSelect.value;

  if (format === "json") {
    downloadGrammarJSONTemplate();
  } else {
    downloadGrammarCSVTemplate();
  }
}

function downloadGrammarJSONTemplate() {
  const template = [
    {
      pattern_id: "pattern_001",
      pattern_name: "Í∏∞Î≥∏ Ïù∏ÏÇ¨",
      pattern_type: "greeting",
      domain: "daily",
      category: "routine",
      difficulty: "beginner",
      tags: ["greeting", "basic", "daily"],
      learning_focus: ["pronunciation", "usage"],
      structural_pattern: "ÏïàÎÖïÌïòÏÑ∏Ïöî",
      explanations: {
        korean: "Í∞ÄÏû• Í∏∞Î≥∏Ï†ÅÏù∏ Ïù∏ÏÇ¨ ÌëúÌòÑÏûÖÎãàÎã§.",
        english: "Basic greeting expression.",
        japanese: "Âü∫Êú¨ÁöÑ„Å™Êå®Êã∂Ë°®Áèæ„Åß„Åô„ÄÇ",
        chinese: "ÊúÄÂü∫Êú¨ÁöÑÈóÆÂÄôË°®Ëææ„ÄÇ",
      },
      usage_examples: [
        {
          korean: "ÏïàÎÖïÌïòÏÑ∏Ïöî! ÎßåÎÇòÏÑú Î∞òÍ∞ëÏäµÎãàÎã§.",
          english: "Hello! Nice to meet you.",
          japanese: "„Åì„Çì„Å´„Å°„ÅØÔºÅ„Åä‰ºö„ÅÑ„Åß„Åç„Å¶Â¨â„Åó„ÅÑ„Åß„Åô„ÄÇ",
          chinese: "‰Ω†Â•ΩÔºÅÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†„ÄÇ",
        },
      ],
    },
    {
      pattern_id: "pattern_002",
      pattern_name: "ÏùåÏãù Ï£ºÎ¨∏",
      pattern_type: "request",
      domain: "food",
      category: "drink",
      difficulty: "beginner",
      tags: ["food", "request", "restaurant"],
      learning_focus: ["grammar", "vocabulary"],
      structural_pattern: "___ÏùÑ/Î•º Ï£ºÏÑ∏Ïöî",
      explanations: {
        korean: "ÏùåÏãùÏù¥ÎÇò Î¨ºÍ±¥ÏùÑ Ï†ïÏ§ëÌïòÍ≤å ÏöîÏ≤≠Ìï† Îïå ÏÇ¨Ïö©Ìï©ÎãàÎã§.",
        english: "Used to politely request food or items.",
        japanese: "È£ü„ÅπÁâ©„ÇÑÁâ©„Çí‰∏ÅÂØß„Å´È†º„ÇÄÊôÇ„Å´‰Ωø„ÅÑ„Åæ„Åô„ÄÇ",
        chinese: "Áî®‰∫éÁ§ºË≤åÂú∞ËØ∑Ê±ÇÈ£üÁâ©ÊàñÁâ©ÂìÅ„ÄÇ",
      },
      usage_examples: [
        {
          korean: "ÍπÄÏπòÏ∞åÍ∞úÎ•º Ï£ºÏÑ∏Ïöî.",
          english: "Please give me kimchi stew.",
          japanese: "„Ç≠„É†„ÉÅ„ÉÅ„Ç≤„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ",
          chinese: "ËØ∑ÁªôÊàëÊ≥°ËèúÊ±§„ÄÇ",
        },
      ],
    },
  ];

  downloadJSON(template, "grammar_template.json");
}

function downloadGrammarCSVTemplate() {
  const headers = [
    "pattern_id",
    "pattern_name",
    "pattern_type",
    "domain",
    "category",
    "difficulty",
    "tags",
    "learning_focus",
    "structural_pattern",
    "korean_explanation",
    "english_explanation",
    "japanese_explanation",
    "chinese_explanation",
  ];

  const sampleData = [
    [
      "pattern_001",
      "Í∏∞Î≥∏ Ïù∏ÏÇ¨",
      "greeting",
      "daily",
      "routine",
      "beginner",
      "greeting|basic|daily",
      "pronunciation|usage",
      "ÏïàÎÖïÌïòÏÑ∏Ïöî",
      "Í∞ÄÏû• Í∏∞Î≥∏Ï†ÅÏù∏ Ïù∏ÏÇ¨ ÌëúÌòÑÏûÖÎãàÎã§.",
      "Basic greeting expression.",
      "Âü∫Êú¨ÁöÑ„Å™Êå®Êã∂Ë°®Áèæ„Åß„Åô„ÄÇ",
      "ÊúÄÂü∫Êú¨ÁöÑÈóÆÂÄôË°®Ëææ„ÄÇ",
    ],
  ];

  downloadCSV([headers, ...sampleData], "grammar_template.csv");
}

// Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§ (readFileÏùÄ csv-parser-utils.jsÏóêÏÑú import)
function parseCSV(content, tabName) {
  const lines = content.split("\n");
  const headers = lines[0].split(",").map((h) => h.trim());
  const data = [];

  for (let i = 1; i < lines.length; i++) {
    if (lines[i].trim()) {
      const values = lines[i].split(",").map((v) => v.trim());
      const item = {};

      headers.forEach((header, index) => {
        item[header] = values[index] || "";
      });

      // ÌÉ≠Î≥Ñ ÌäπÏàò Ï≤òÎ¶¨
      if (tabName === "concepts") {
        data.push(convertCSVToConcept(item));
      } else if (tabName === "examples") {
        data.push(convertCSVToExample(item));
      } else if (tabName === "grammar") {
        data.push(convertCSVToGrammar(item));
      }
    }
  }

  return data;
}

function convertCSVToConcept(item) {
  return {
    concept_info: {
      domain: item.domain || "general",
      category: item.category || "uncategorized",
      difficulty: item.difficulty || "beginner",
      unicode_emoji: item.emoji || "üìù",
      tags: item.tags ? item.tags.split("|") : [],
    },
    expressions: {
      korean: {
        word: item.korean_word || "",
        pronunciation: item.korean_pronunciation || "",
        definition: item.korean_definition || "",
        part_of_speech: item.korean_part_of_speech || "noun",
      },
      english: {
        word: item.english_word || "",
        pronunciation: item.english_pronunciation || "",
        definition: item.english_definition || "",
        part_of_speech: item.english_part_of_speech || "noun",
      },
    },
    representative_example:
      item.representative_example_korean || item.representative_example_english
        ? {
            example_id: `${item.korean_word || "concept"}_rep_example`,
            context: "general",
            difficulty: item.difficulty || "beginner",
            translations: {
              korean: { text: item.representative_example_korean || "" },
              english: { text: item.representative_example_english || "" },
            },
          }
        : null,
  };
}

function convertCSVToExample(item) {
  return {
    example_id: item.example_id || `example_${Date.now()}`,
    domain: item.domain || "general",
    category: item.category || "common",
    context: item.context || "general",
    difficulty: item.difficulty || "beginner",
    tags: item.tags ? item.tags.split("|") : [],
    translations: {
      korean: {
        text: item.korean_text || "",
        romanization: item.korean_romanization || "",
      },
      english: {
        text: item.english_text || "",
        phonetic: item.english_phonetic || "",
      },
      japanese: {
        text: item.japanese_text || "",
        romanization: item.japanese_romanization || "",
      },
    },
  };
}

function convertCSVToGrammar(item) {
  return {
    pattern_id: item.pattern_id || `pattern_${Date.now()}`,
    pattern_name: item.pattern_name || "Í∏∞Î≥∏ Ìå®ÌÑ¥",
    pattern_type: item.pattern_type || "basic",
    domain: item.domain || "general",
    category: item.category || "common",
    difficulty: item.difficulty || "beginner",
    tags: item.tags ? item.tags.split("|") : [],
    learning_focus: item.learning_focus ? item.learning_focus.split("|") : [],
    structural_pattern: item.structural_pattern || "",
    explanations: {
      korean: item.korean_explanation || "",
      english: item.english_explanation || "",
      japanese: item.japanese_explanation || "",
      chinese: item.chinese_explanation || "",
    },
    usage_examples: item.usage_examples ? JSON.parse(item.usage_examples) : [],
  };
}

function downloadJSON(data, filename) {
  const jsonString = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonString], { type: "application/json" });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", filename);
  link.style.visibility = "hidden";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function downloadCSV(data, filename) {
  const csvContent = data.map((row) => row.join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv" });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", filename);
  link.style.visibility = "hidden";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞
window.openSeparatedImportModal = function () {
  const modal = document.getElementById("separated-import-modal");
  if (modal) {
    modal.classList.remove("hidden");

    // Ï≤´ Î≤àÏß∏ ÌÉ≠ ÌôúÏÑ±Ìôî
    document.getElementById("concepts-tab")?.click();
  }
};
